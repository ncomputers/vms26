<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Diagnostics Overlay</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 12px; }
    img { max-width: 640px; height: auto; display:block; margin-top:10px; }
    table { border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; }
    label { margin-right: 8px; }
    .row { margin-bottom: 8px; }
    input[type=text] { width: 300px; }
  </style>
</head>
<body>
  <h3>Diagnostics Overlay</h3>
  <form method="get">
    <div class="row">
      <label>Model:
        <select name="model">
          <option value="basic" {{ 'selected' if params.model=='basic' else '' }}>basic</option>
          <option value="ppe" {{ 'selected' if params.model=='ppe' else '' }}>ppe</option>
        </select>
      </label>
      <label>Conf:
        <input type="number" step="0.05" min="0.05" max="0.9" name="conf" value="{{ '%.2f'|format(params.conf) }}">
      </label>
      <label>Tracker:
        <input type="checkbox" name="tracker" value="1" {{ 'checked' if params.tracker else '' }}>
      </label>
      <label title="nudge centers across the line">Simulate crossings:
        <input type="checkbox" name="simulate" value="1" {{ 'checked' if params.simulate else '' }}>
      </label>
      <label>Line:
        <select name="line_orientation">
          <option value="vertical" {{ 'selected' if params.line_orientation=='vertical' else '' }}>vertical</option>
          <option value="horizontal" {{ 'selected' if params.line_orientation=='horizontal' else '' }}>horizontal</option>
        </select>
        <input type="number" step="0.01" min="0" max="1" name="line_ratio" value="{{ '%.2f'|format(params.line_ratio) }}">
      </label>
    </div>
    <div class="row">
      <label>Src override:
        <input type="text" name="src" value="{{ params.src }}" placeholder="rtsp:// or path/to/file">
      </label>
      <button type="submit">Run</button>
    </div>
  </form>

  <button type="button" id="run-checks">Run All Checks</button>
  <table id="check-results">
    <tr><th>Step</th><th>Status</th><th>ms</th><th>Hints</th></tr>
  </table>

  {% if result.jpeg %}
    <img src="data:image/jpeg;base64,{{ result.jpeg }}" alt="overlay">
  {% endif %}

  <table>
    <tr><th>Step</th><th>OK</th><th>ms</th><th>Detail</th></tr>
    {% for s in result.steps %}
      <tr><td>{{ s.name }}</td><td>{{ 'yes' if s.ok else 'no' }}</td><td>{{ s.ms }}</td><td>{{ s.detail }}</td></tr>
    {% endfor %}
  </table>

  <h4>Detections</h4>
  <pre>{{ result.dets | tojson(indent=2) }}</pre>
  <h4>Tracks</h4>
  <pre>{{ result.tracks | tojson(indent=2) }}</pre>
  <h4>Counts</h4>
  <pre>{{ result.counts | tojson(indent=2) }}</pre>
  <h4>Line</h4>
  <pre>{{ result.line | tojson(indent=2) }}</pre>

  <script>
  document.getElementById('run-checks').addEventListener('click', async () => {
    const params = new URLSearchParams(window.location.search);
    params.set('cam_id', {{ cam_id }});
    const resp = await fetch('/diagnostics/overlay/checks?' + params.toString());
    const data = await resp.json();
    const tbl = document.getElementById('check-results');
    tbl.innerHTML = '<tr><th>Step</th><th>Status</th><th>ms</th><th>Hints</th></tr>';
    for (const s of data.steps) {
      const tr = document.createElement('tr');
      const hints = s.hints ? s.hints.join('; ') : '';
      tr.innerHTML = `<td>${s.name}</td><td>${s.ok ? '✅' : '❌'}</td><td>${s.ms}</td><td>${hints}</td>`;
      tbl.appendChild(tr);
    }
  });
  </script>
</body>
</html>
